name: Validate New Token Configurations

on:
  pull_request:
    paths:
      - "registry/mainnet/interchain/squid.tokenlist.json"

jobs:
  validate-tokens:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16"

      - name: Install dependencies
        run: |
          npm install ethers@5.7.2
          npm install axios

      - name: Extract and validate new tokens
        run: |
          git fetch origin ${{ github.base_ref }}
          BASE_FILE=$(git show origin/${{ github.base_ref }}:registry/mainnet/interchain/squid.tokenlist.json)
          CURRENT_FILE=$(cat registry/mainnet/interchain/squid.tokenlist.json)

          NEW_TOKENS=$(node -e "
            const base = JSON.parse('$BASE_FILE');
            const current = JSON.parse('$CURRENT_FILE');
            const newTokens = Object.entries(current.tokens)
              .filter(([id, token]) => !base.tokens[id])
              .reduce((obj, [id, token]) => ({ ...obj, [id]: token }), {});
            console.log(JSON.stringify(newTokens, null, 2));
          ")

          echo "$NEW_TOKENS" > new_tokens.json
          node validate-token-configs.js

      - name: Check validation results
        run: |
          if [ -f validation_errors.txt ]; then
            echo "Validation errors found:"
            cat validation_errors.txt
            exit 1
          else
            echo "All new token configurations are valid."
          fi
