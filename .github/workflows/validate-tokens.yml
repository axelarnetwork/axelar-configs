name: Validate New Token Configurations

on:
  pull_request:
    paths:
      - "registry/mainnet/interchain/squid.tokenlist.json"

jobs:
  validate-tokens:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16"

      - name: Install dependencies
        run: |
          npm install ethers@5.7.2
          npm install axios

      - name: Extract and validate new tokens
        run: |
          git fetch origin main:main
          DIFF=$(git diff main...HEAD -- registry/mainnet/interchain/squid.tokenlist.json | grep '^+' | grep -v '+++')
          NEW_TOKENS=$(echo "$DIFF" | sed -n '/"0x/,/]/{/]/q;p}' | jq -s 'reduce .[] as $item ({}; . + ($item | fromjson))')
          echo "$NEW_TOKENS" > new_tokens.json
          node validate-token-configs.js

      - name: Check validation results
        run: |
          if [ -f validation_errors.txt ]; then
            echo "Validation errors found:"
            cat validation_errors.txt
            exit 1
          else
            echo "All new token configurations are valid."
          fi
